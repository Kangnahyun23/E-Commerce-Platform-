// Kính Tốt - Prisma Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


enum Role {
  BUYER
  SELLER
  STAFF
  ADMIN
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProductCondition {
  NEW
  LIKE_NEW
  USED
}

enum FrameMaterial {
  METAL
  ACETATE
  TITANIUM
  PLASTIC
  WOOD
}

enum FrameShape {
  ROUND
  OVAL
  SQUARE
  RECTANGLE
  CAT_EYE
  AVIATOR
}

enum LensType {
  SINGLE_VISION
  BIFOCAL
  PROGRESSIVE
  SUNGLASSES
  BLUE_LIGHT
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPING
  DELIVERED
  CANCELLED
}

enum MessageRole {
  USER
  AI
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  fullName  String   @map("full_name")
  phone     String?
  avatar    String?
  role      Role     @default(BUYER)
  createdAt DateTime @default(now()) @map("created_at")

  sellerProfile SellerProfile?
  products      Product[]
  orders        Order[]
  reviews       Review[]
  chatSessions  ChatSession[]

  @@map("users")
}

model SellerProfile {
  id           String     @id @default(cuid())
  userId       String     @unique @map("user_id")
  shopName     String     @map("shop_name")
  description  String?
  kycDocument  String?    @map("kyc_document")
  kycStatus    KycStatus  @default(PENDING) @map("kyc_status")
  approvedAt   DateTime?  @map("approved_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("seller_profiles")
}

model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  image       String?
  createdAt   DateTime  @default(now()) @map("created_at")

  products Product[]

  @@map("categories")
}

model Product {
  id           String           @id @default(cuid())
  sellerId     String           @map("seller_id")
  categoryId   String           @map("category_id")
  name         String
  slug         String           @unique
  description  String?
  price        Decimal         @db.Decimal(12, 2)
  salePrice    Decimal?        @map("sale_price") @db.Decimal(12, 2)
  images       Json?            // array of image URLs
  condition    ProductCondition @default(NEW)
  frameMaterial FrameMaterial?  @map("frame_material")
  frameShape   FrameShape?      @map("frame_shape")
  lensType     LensType?        @map("lens_type")
  gender       String?          // UNISEX, MEN, WOMEN
  stock        Int              @default(0)
  isActive     Boolean          @default(true) @map("is_active")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")

  seller   User         @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  category Category     @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  orderDetails OrderDetail[]
  reviews  Review[]

  @@map("products")
}

model Order {
  id               String      @id @default(cuid())
  buyerId          String      @map("buyer_id")
  totalAmount      Decimal     @map("total_amount") @db.Decimal(12, 2)
  status           OrderStatus @default(PENDING)
  shippingAddress  String     @map("shipping_address")
  phone            String
  note             String?
  paymentMethod    String?     @map("payment_method")
  vnpTransactionNo String?     @map("vnp_transaction_no")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  buyer  User          @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  details OrderDetail[]

  @@map("orders")
}

model OrderDetail {
  id        String   @id @default(cuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  quantity  Int
  price     Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([orderId, productId])
  @@map("order_details")
}

model Review {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model ChatSession {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  title     String   @default("AI Stylist")
  createdAt DateTime @default(now()) @map("created_at")

  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id                 String     @id @default(cuid())
  sessionId          String     @map("session_id")
  role               MessageRole
  content            String     @db.Text
  productSuggestions Json?      @map("product_suggestions") // array of product IDs or objects
  createdAt          DateTime   @default(now()) @map("created_at")

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}
